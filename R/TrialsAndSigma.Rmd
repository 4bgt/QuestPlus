---
title: "Simulation: Constant Stimuli vs Quest+ with Experiment Parameters and varying Sigma"
author: "Niklas Hypki"
date: "`r Sys.Date()`"
output: html_document
---
## Quest+ 

```{r, echo=FALSE,message=F,warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(dplyr)
library(ggplot2)
library(quickpsy)
library(plotrix)

QuestPlus <- read_csv(paste0("Quest+ restricted sigma.csv"))
all = data.frame() 
for (subjects in c(5, 10,20,30)) #
{
  for (mu in unique(QuestPlus$trueMu))
  {
    for (sigma in unique(QuestPlus$trueSigma))
    {
      for (saturation in unique(QuestPlus$trueSaturation))
      {
        
        for (maxTrials in c(20,30,40,50,100)) #
        {
          ##### Quest+ #####
          QuestPlusTest = QuestPlus[QuestPlus$trial<=maxTrials & QuestPlus$simulationRun<subjects,]
          QuestPlusTest$simulationRun = as.factor(QuestPlusTest$simulationRun)
          
          ##### average responses #####
          questPlusResult = QuestPlusTest[QuestPlusTest$trueMu == mu & QuestPlusTest$trueSigma ==sigma &QuestPlusTest$trueSaturation == saturation,]
          
          average_responses = questPlusResult %>% group_by(simulationRun,stimulus) %>% summarize(Mean = mean(response),n = length(response))
          
          ##### plot responses and distribution #####
          quest_plot = ggplot(average_responses,aes(stimulus,Mean,color=simulationRun))+geom_point()
          
          cat("Psychometric fit for Quest+ Simulation with: trials: ",max(questPlusResult$trial), " mu =",mu," sigma =",sigma,"saturation = ",saturation,"subjects = ", subjects, " \n")
          
          allEstimatedParameters = data.frame()  
          
          for (currentSimulationRun in unique(questPlusResult$simulationRun))
          {
            questPlusRun = questPlusResult[questPlusResult$simulationRun == currentSimulationRun,]
            
            estimated_parameters = c(run = as.numeric(currentSimulationRun), mu = questPlusRun$estimatedMu[nrow(questPlusRun)],sigma = questPlusRun$estimatedSigma[nrow(questPlusRun)], saturation = questPlusRun$estimatedSaturation[nrow(questPlusRun)],subjects = subjects,trueMu = mu, trueSigma = sigma,trials = maxTrials)
            
            allEstimatedParameters =bind_rows(allEstimatedParameters,estimated_parameters)
            
            estimated_distribution = data.frame(x=seq(-0.21,0.21,0.001), y=estimated_parameters[4] + (1-estimated_parameters[4] - estimated_parameters[4]) * pnorm(seq(-0.21,0.21,0.001), estimated_parameters[2], estimated_parameters[3]),simulationRun = currentSimulationRun)
            
            segements = data.frame(x = estimated_parameters[2], y = 0.5,yend =0, simulationRun = currentSimulationRun)
            
            quest_plot = quest_plot+geom_line(data= estimated_distribution,aes(x,y)) +geom_segment(data = segements,aes(x = x,xend=x,y = y,yend = yend) )+geom_vline(xintercept=mu)+xlim(-0.21,0.21)  +theme_bw()+ylab("Probability (rightward)") + xlab("Stimulus (PI / Curvature Gain radius)")
            
          }
          names(allEstimatedParameters) = c ("run","mu","sigma","saturation","subjects","trueMu","trueSigma","nTrials")
          
          print(format(allEstimatedParameters, digits=2,scientific=F))
          
          meanEstimates = data.frame("mean Mu" = mean(allEstimatedParameters$mu),"standard Error" = std.error(allEstimatedParameters$mu))
          
          print(format(meanEstimates, digits=2,scientific=F))
          
          test = quest_plot+geom_point(data =meanEstimates,aes(x= mean.Mu,y= 0.5,color = "average mu"))+
            geom_segment(data = meanEstimates,aes(x = mean.Mu-standard.Error,xend=mean.Mu+standard.Error,y = 0.5,yend = 0.5,color = "average mu"))
          
          
          plot(test)
          all = bind_rows(all,allEstimatedParameters)
          
          
          
        }
      }
    }
  }
}

all$error = abs(all$mu-all$trueMu)


average = group_by(all, subjects,trueMu,trueSigma,nTrials) %>% summarise(meanError = mean(error,na.rm=T))

for (mu in unique(QuestPlus$trueMu))
{
  
  for (subjects in c(5, 10,20,30)) 
  {
    cat("Summary plots: subjects = ",subjects," mu = ",mu, " \n")
    currentSummary = average[average$subjects ==subjects & average$trueMu == mu,]
    
    summaryPlot1 = ggplot(currentSummary,aes(nTrials,trueSigma,fill = meanError))+
      geom_tile(color = "black")+theme_bw()+xlab("Number of Trials in Run")+ylab("true Sigma")+ 
      scale_fill_continuous(name="Estimation Error \n (PI / radius)",limits = c(0, 0.15))
    
    print(summaryPlot1)
  }
}
for (maxTrials in c(20,30,40,50,100)) 
{
  for (subjects in c(5, 10,20,30))
  {
        cat("Summary plots: subjects = ",subjects," trials = ",maxTrials, " \n")
    currentSummary = average[average$subjects ==subjects & average$nTrials == maxTrials,]
    
        summaryPlot2 = ggplot(currentSummary,aes(trueMu,trueSigma,fill = meanError))+
      geom_tile(color = "black")+theme_bw()+xlab("true Mu")+ylab("true Sigma")+ 
      scale_fill_continuous(name="Estimation Error \n (PI / radius)",limits = c(0, 0.15))
    
        print(summaryPlot2)
  }
}


```