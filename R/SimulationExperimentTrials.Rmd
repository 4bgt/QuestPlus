---
title: "Simulation: Constant Stimuli vs Quest+ with Experiment Parameters and varying number of trials"
author: "Niklas Stein"
date: "`r Sys.Date()`"
output: html_document
---
## Constant Stimuli vs Quest+

```{r constant stimuli vs quest+, echo=FALSE,message=F,warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(dplyr)
library(ggplot2)
library(quickpsy)
for (repeatedTrials in c(1:4))
{
  #### Constant Stimuli ####
  constantStimuliTest <- read_csv(paste0("constantStimuli",repeatedTrials,".csv"),show_col_types = FALSE)
  constantStimuliTest$simulationRun = as.factor(constantStimuliTest$simulationRun)
  constantStimuliTest$simulationId = as.factor(constantStimuliTest$simulationId)
  
  for (mu in unique(constantStimuliTest$trueMu))
  {
    for (sigma in c(0.2))
    {
      for (saturation in unique(constantStimuliTest$trueSaturation))
      {
        ##### average responses #####
        currentSimulation = constantStimuliTest[constantStimuliTest$trueMu == mu & constantStimuliTest$trueSigma ==sigma,]  
        
        average_responses = currentSimulation %>% group_by(simulationRun,stimulus) %>% summarize(Mean = mean(response),n = length(response))
        
        ##### fit psychometric function to responses  ##### 
        fit <- quickpsy(currentSimulation, stimulus, response, bootstrap = "none",grouping = .(simulationRun),guess = 0,lapses = 0,xmin = -0.21,xmax = 0.21) 
        
        constantPlot=plot(fit)+geom_point(data = average_responses,aes(stimulus,Mean,color=simulationRun))+geom_vline(xintercept=mu)+xlim(-0.21,0.21)
        cat("Psychometric fit for constant stimulus Simulation with: trials: ",max(currentSimulation$trial), " mu =",mu," sigma =",sigma,"saturation = ",saturation," \n")
        
        parameters = data.frame(run = unique(average_responses$simulationRun),mu = fit$par$par[fit$par$parn == "p1"],sigma = fit$par$par[fit$par$parn == "p2"])
        
        
        print(format(parameters, digits=2,scientific=F))
        
        plot(constantPlot)
        
        
      }
    }
  }
  
  ##### Quest+ #####
  QuestPlusTest <- read_csv(paste0("Quest+",repeatedTrials,".csv"))
  QuestPlusTest$simulationRun = as.factor(QuestPlusTest$simulationRun)
  
  singlePlots = T
  
  
  
  for (mu in unique(QuestPlusTest$trueMu))
  {
    for (sigma in c(0.2))
    {
      for (saturation in unique(QuestPlusTest$trueSaturation))
      {
        ##### average responses #####
        questPlusResult = QuestPlusTest[QuestPlusTest$trueMu == mu & QuestPlusTest$trueSigma ==sigma &QuestPlusTest$trueSaturation == saturation,]
        
        average_responses = questPlusResult %>% group_by(simulationRun,stimulus) %>% summarize(Mean = mean(response),n = length(response))
        
        
        if(singlePlots)
        {
          for (i in unique(questPlusResult$simulationRun))
          {
            sampleRun = questPlusResult[questPlusResult$simulationRun==i,]
            sampleRun$responseValue = "false"
            sampleRun$responseValue[sampleRun$response] = "correct"
            
            p1 = ggplot(sampleRun,aes(x=trial,y=estimatedMu))+
              geom_rect(aes(xmin = trial-0.5, xmax = trial+0.5,
                            ymin = -Inf, ymax = Inf,
                            fill = responseValue,alpha = 0.2),
                        size = 0.7,
                        show.legend = FALSE) +geom_line(aes(color = "mu"))+geom_line(aes(y=stimulus,color = "stimulus"))+
              scale_fill_manual(values = c("green4", "red3"))+
              scale_color_manual(values = c(mu ="blue",stimulus = "black"))+ylim(-0.22,0.22)
            ggsave(p1,file = paste0("QP",i,".png"))
          }
        }
        
        
        ##### plot responses and distribution #####
        quest_plot = ggplot(average_responses,aes(stimulus,Mean,color=simulationRun))+geom_point()
        
        cat("Psychometric fit for Quest+ Simulation with: trials: ",max(questPlusResult$trial), " mu =",mu," sigma =",sigma,"saturation = ",saturation," \n")
        
        allEstimatedParameters = data.frame()  
        
        for (currentSimulationRun in unique(questPlusResult$simulationRun))
        {
          questPlusRun = questPlusResult[questPlusResult$simulationRun == currentSimulationRun,]
          
          estimated_parameters = c(run = as.numeric(currentSimulationRun), mu = questPlusRun$estimatedMu[nrow(questPlusRun)],sigma = questPlusRun$estimatedSigma[nrow(questPlusRun)], saturation = questPlusRun$estimatedSaturation[nrow(questPlusRun)])
          
          allEstimatedParameters =rbind(allEstimatedParameters,estimated_parameters)
          
          estimated_distribution = data.frame(x=seq(-0.21,0.21,0.001), y=estimated_parameters[4] + (1-estimated_parameters[4] - estimated_parameters[4]) * pnorm(seq(-0.21,0.21,0.001), estimated_parameters[2], estimated_parameters[3]),simulationRun = currentSimulationRun)
          
          segements = data.frame(x = estimated_parameters[2], y = 0.5,yend =0, simulationRun = currentSimulationRun)
          
          quest_plot = quest_plot+geom_line(data= estimated_distribution,aes(x,y)) +geom_segment(data = segements,aes(x = x,xend=x,y = y,yend = yend) )+geom_vline(xintercept=mu)+xlim(-0.21,0.21)  
        }
        names(allEstimatedParameters) = c ("run","mu","sigma","saturation")
        
        print(format(allEstimatedParameters, digits=2,scientific=F))
        
        plot(quest_plot)
      }
    }
  }
}

```